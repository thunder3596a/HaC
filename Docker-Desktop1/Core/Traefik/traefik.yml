networks:
  aiproxy:
    name: aiproxy

services:
  traefik:
    image: traefik:latest
    container_name: traefik
    restart: unless-stopped

    # Resource limits for gaming performance
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '1.0'
        reservations:
          memory: 64M
          cpus: '0.1'

    labels:
      # Home Assistant monitoring
      - ha.monitor=true
      - ha.category=networking
      - ha.compose-file=Docker-Desktop1/Core/Traefik/traefik.yml
      - ha.service-name=traefik
      # Traefik routing
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.entrypoints=websecure"
      - "traefik.http.routers.dashboard.rule=Host(`docker-desktop1-traefik.${DOMAIN_NAME}`)"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.tls.certresolver=${CERTRESOLVER:-cloudflare}"

    command:
      - "--api=true"
      - "--api.dashboard=true"

      # EntryPoints
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"

      # HTTP -> HTTPS redirect
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"

      # TLS + ACME via Cloudflare
      - "--entrypoints.websecure.http.tls.domains[0].main=u-acres.com"
      - "--entrypoints.websecure.http.tls.domains[0].sans=*.u-acres.com"
      - "--certificatesresolvers.cloudflare.acme.email=${LETS_ENCRYPT_EMAIL}"
      - "--certificatesresolvers.cloudflare.acme.dnschallenge=true"
      - "--certificatesresolvers.cloudflare.acme.dnschallenge.delaybeforecheck=0"
      - "--certificatesresolvers.cloudflare.acme.dnschallenge.provider=cloudflare"
      - "--certificatesresolvers.cloudflare.acme.dnschallenge.resolvers[0]=1.1.1.1:53"
      - "--certificatesresolvers.cloudflare.acme.dnschallenge.resolvers[1]=8.8.8.8:53"
      - "--certificatesresolvers.cloudflare.acme.storage=/etc/traefik/acme.json"

      # Logging
      - "--log.level=INFO"

      # Docker provider
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=aiproxy"

      # File provider for native services
      - "--providers.file=true"
      - "--providers.file.directory=/etc/traefik/dynamic"
      - "--providers.file.watch=true"

    environment:
      - CLOUDFLARE_EMAIL=${CLOUDFLARE_EMAIL}
      - CLOUDFLARE_DNS_API_TOKEN=${CLOUDFLARE_DNS_API_TOKEN}
      - CLOUDFLARE_ZONE_API_TOKEN=${CLOUDFLARE_ZONE_API_TOKEN}
      - CF_DNS_API_TOKEN=${CLOUDFLARE_DNS_API_TOKEN}
      - CF_ZONE_API_TOKEN=${CLOUDFLARE_ZONE_API_TOKEN}
      - LETS_ENCRYPT_EMAIL=${LETS_ENCRYPT_EMAIL}
      - TZ=${TZ}

    networks:
      - aiproxy

    extra_hosts:
      - "host.docker.internal:host-gateway"

    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik_data:/etc/traefik
      - ./dynamic:/etc/traefik/dynamic:ro

volumes:
  traefik_data:
    name: traefik_data
