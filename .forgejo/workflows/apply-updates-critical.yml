name: Apply Updates - Docker Critical

on:
  workflow_dispatch:
    inputs:
      containers:
        description: 'Containers to update (comma-separated, or "all" for all with updates)'
        required: false
        default: 'all'
        type: string
      bootstrap:
        description: 'Bootstrap mode: recreate all containers to apply labels'
        required: false
        default: false
        type: boolean

jobs:
  apply-updates:
    runs-on: docker-critical

    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.FORGEJO_TOKEN }}
          ref: main

      - name: Pull and recreate containers
        env:
          DOMAIN_NAME: ${{ vars.DOMAIN_NAME }}
          CERTRESOLVER: ${{ vars.CERTRESOLVER }}
          TZ: ${{ vars.TZ }}
          HOMEASSISTANT_MARIADB_ROOT_PASSWORD: ${{ secrets.HOMEASSISTANT_MARIADB_ROOT_PASSWORD }}
          HOMEASSISTANT_MARIADB_PASSWORD: ${{ secrets.HOMEASSISTANT_MARIADB_PASSWORD }}
          CLOUDFLARE_EMAIL: ${{ vars.CLOUDFLARE_EMAIL }}
          CLOUDFLARE_DNS_API_TOKEN: ${{ secrets.CLOUDFLARE_DNS_API_TOKEN }}
          CLOUDFLARE_ZONE_API_TOKEN: ${{ secrets.CLOUDFLARE_ZONE_API_TOKEN }}
          LETS_ENCRYPT_EMAIL: ${{ vars.LETS_ENCRYPT_EMAIL }}
          CONTAINERS: ${{ github.event.inputs.containers }}
          BOOTSTRAP: ${{ github.event.inputs.bootstrap }}
        run: |
          # Build container maps from Docker labels (ha.monitor=true) OR from git compose files (bootstrap mode)
          declare -A COMPOSE_MAP
          declare -A SERVICE_MAP

          if [ "$BOOTSTRAP" = "true" ]; then
            echo "=== BOOTSTRAP MODE: Building maps from git compose files ==="
            # Find all compose files with ha.monitor=true labels in git
            while IFS= read -r compose_file; do
              if [ -f "$compose_file" ]; then
                # Extract services with ha.monitor=true label
                while IFS= read -r line; do
                  service_name=$(echo "$line" | cut -d: -f1)
                  container_name=$(grep -A 20 "^  $service_name:" "$compose_file" | grep "container_name:" | head -1 | awk '{print $2}')

                  if [ -n "$container_name" ] && [ "$container_name" != "null" ]; then
                    COMPOSE_MAP["$container_name"]="$compose_file"
                    SERVICE_MAP["$container_name"]="$service_name"
                    echo "Registered (bootstrap): $container_name -> $compose_file (service: $service_name)"
                  fi
                done < <(grep -B 5 "ha.monitor=true" "$compose_file" | grep "^  [a-z]" | grep ":" || true)
              fi
            done < <(find Docker-Critical -name "*.yml" -type f)
          else
            echo "=== NORMAL MODE: Building maps from running container labels ==="
            # Query Docker API for all containers with ha.monitor=true
            containers_json=$(curl -s http://localhost:2375/containers/json?all=true)

            # Parse JSON and build maps
            while IFS= read -r line; do
              container_name=$(echo "$line" | jq -r '.name')
              compose_file=$(echo "$line" | jq -r '.compose_file')
              service_name=$(echo "$line" | jq -r '.service_name')

              if [ -n "$container_name" ] && [ "$container_name" != "null" ]; then
                COMPOSE_MAP["$container_name"]="$compose_file"
                SERVICE_MAP["$container_name"]="$service_name"
                echo "Registered: $container_name -> $compose_file (service: $service_name)"
              fi
            done < <(echo "$containers_json" | jq -c '.[] | select(.Labels["ha.monitor"] == "true") | {name: .Names[0] | ltrimstr("/"), compose_file: .Labels["ha.compose-file"], service_name: .Labels["ha.service-name"]}')
          fi

          updated=""

          if [ "$BOOTSTRAP" = "true" ]; then
            # Bootstrap mode: recreate ALL containers from compose files to apply labels
            echo "=== BOOTSTRAP: Will recreate all containers to apply labels ==="
            CONTAINERS=$(IFS=,; echo "${!COMPOSE_MAP[*]}")
            echo "Containers to bootstrap: $CONTAINERS"
          elif [ "$CONTAINERS" = "all" ]; then
            # Check all and update those with available updates
            chmod +x ./scripts/check-docker-updates.sh
            CONTAINERS=""
            for container in "${!COMPOSE_MAP[@]}"; do
              if docker ps --format '{{.Names}}' | grep -q "^${container}$"; then
                result=$(./scripts/check-docker-updates.sh "$container")
                echo "Checking $container: $result"
                if [ "$result" != "[]" ] && [ -n "$result" ]; then
                  if [ -z "$CONTAINERS" ]; then
                    CONTAINERS="$container"
                  else
                    CONTAINERS="${CONTAINERS},${container}"
                  fi
                fi
              fi
            done
            echo "Containers to update: $CONTAINERS"
          fi

          if [ -z "$CONTAINERS" ]; then
            echo "No containers need updating"
            exit 0
          fi

          # Update each container
          IFS=',' read -ra CONTAINER_LIST <<< "$CONTAINERS"
          for container in "${CONTAINER_LIST[@]}"; do
            container=$(echo "$container" | xargs)  # trim whitespace
            compose_file="${COMPOSE_MAP[$container]}"
            service_name="${SERVICE_MAP[$container]}"

            if [ -n "$compose_file" ] && [ -f "$compose_file" ]; then
              echo "Updating container $container (service: $service_name) using $compose_file"

              # Pull new image
              image=$(docker inspect --format='{{.Config.Image}}' "$container" 2>/dev/null)
              if [ -n "$image" ]; then
                docker pull "$image"
              fi

              # Recreate container using service name
              cd "$(dirname "$compose_file")"
              docker compose -f "$(basename "$compose_file")" up -d --force-recreate "$service_name" || true
              cd - > /dev/null

              updated="${updated}${container}, "
            else
              echo "Warning: No compose file mapped for $container"
            fi
          done

          echo "Updated containers: ${updated%, }"

      - name: Wait for services to stabilize
        run: sleep 15

      - name: Notify Home Assistant of completion
        continue-on-error: true
        env:
          HA_URL: ${{ vars.HA_URL }}
          HA_TOKEN: ${{ secrets.HA_LONG_LIVED_TOKEN }}
          CONTAINERS: ${{ github.event.inputs.containers }}
        run: |
          # Retry up to 3 times with 10 second delay
          for i in 1 2 3; do
            if curl -s --fail --max-time 30 -X POST \
              -H "Authorization: Bearer ${HA_TOKEN}" \
              -H "Content-Type: application/json" \
              -d "{
                \"event_type\": \"docker_updates_applied\",
                \"event_data\": {
                  \"host\": \"docker-critical\",
                  \"containers\": \"${CONTAINERS}\"
                }
              }" \
              "${HA_URL}/api/events/docker_updates_applied"; then
              echo "Successfully notified Home Assistant"
              exit 0
            fi
            echo "Attempt $i failed, retrying in 10 seconds..."
            sleep 10
          done
          echo "Failed to notify Home Assistant after 3 attempts"
