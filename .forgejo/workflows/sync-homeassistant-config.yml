name: Sync Home Assistant Config

on:
  schedule:
    # Run every 6 hours to pull changes from repo
    - cron: '0 */6 * * *'
  workflow_dispatch:
  repository_dispatch:
    types: [ha-config-updated]

jobs:
  sync:
    runs-on: docker-critical
    
    defaults:
      run:
        shell: sh
        working-directory: /srv/homeassistant/config

    steps:
      - name: Pull latest config from Forgejo
        run: |
          git fetch origin main
          git reset --hard origin/main
          
      - name: Check if configs changed
        id: changes
        run: |
          if git diff --quiet HEAD@{1} HEAD; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
          
      - name: Restart Home Assistant if configs changed
        if: steps.changes.outputs.changed == 'true'
        run: |
          echo "Configuration changed, restarting Home Assistant..."
          docker restart homeassistant
          
      - name: Wait for Home Assistant to start
        if: steps.changes.outputs.changed == 'true'
        run: |
          sleep 30
          docker logs homeassistant --tail 10
