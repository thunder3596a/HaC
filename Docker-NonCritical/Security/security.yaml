networks:
  secproxy:
    external: true

services:
  wazuh.indexer:
    image: wazuh/wazuh-indexer:${WAZUH_VERSION:-4.14.3}
    hostname: wazuh.indexer
    container_name: wazuh-indexer
    restart: unless-stopped

    # Resource limits
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2.0'
        reservations:
          memory: 1G
          cpus: '0.5'

    labels:
      # Home Assistant monitoring
      - ha.monitor=true
      - ha.category=security
      - ha.compose-file=Docker-NonCritical/Security/security.yaml
      - ha.service-name=wazuh.indexer
      # Watchtower updates
      - com.centurylinklabs.watchtower.enable=true

    environment:
      - OPENSEARCH_JAVA_OPTS=-Xms1g -Xmx1g
      - discovery.type=single-node
      - bootstrap.memory_lock=true
      # Disable SSL for internal communication (using Docker network)
      - plugins.security.disabled=true

    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536

    volumes:
      - wazuh-indexer-data:/var/lib/wazuh-indexer

    networks:
      - secproxy

  wazuh.manager:
    image: wazuh/wazuh-manager:${WAZUH_VERSION:-4.14.3}
    hostname: wazuh.manager
    container_name: wazuh-manager
    restart: unless-stopped

    # Resource limits
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2.0'
        reservations:
          memory: 512M
          cpus: '0.5'

    labels:
      # Home Assistant monitoring
      - ha.monitor=true
      - ha.category=security
      - ha.compose-file=Docker-NonCritical/Security/security.yaml
      - ha.service-name=wazuh.manager
      # Watchtower updates
      - com.centurylinklabs.watchtower.enable=true

    ports:
      - "1514:1514"     # Wazuh agent communication
      - "1515:1515"     # Wazuh agent enrollment
      - "514:514/udp"   # Syslog
      - "55000:55000"   # Wazuh API

    environment:
      - INDEXER_URL=http://wazuh.indexer:9200
      - INDEXER_USERNAME=${WAZUH_INDEXER_USERNAME:-admin}
      - INDEXER_PASSWORD=${WAZUH_INDEXER_PASSWORD}
      # Disable SSL for internal communication
      - FILEBEAT_SSL_VERIFICATION_MODE=none
      - API_USERNAME=${WAZUH_API_USERNAME:-wazuh-wui}
      - API_PASSWORD=${WAZUH_API_PASSWORD}

    volumes:
      - wazuh_api_configuration:/var/ossec/api/configuration
      - wazuh_etc:/var/ossec/etc
      - wazuh_logs:/var/ossec/logs
      - wazuh_queue:/var/ossec/queue
      - wazuh_var_multigroups:/var/ossec/var/multigroups
      - wazuh_integrations:/var/ossec/integrations
      - wazuh_active_response:/var/ossec/active-response/bin
      - wazuh_agentless:/var/ossec/agentless
      - wazuh_wodles:/var/ossec/wodles
      - filebeat_etc:/etc/filebeat
      - filebeat_var:/var/lib/filebeat

    networks:
      - secproxy

    depends_on:
      - wazuh.indexer

  wazuh.dashboard:
    image: wazuh/wazuh-dashboard:${WAZUH_VERSION:-4.14.3}
    hostname: wazuh.dashboard
    container_name: wazuh-dashboard
    restart: unless-stopped

    # Resource limits
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.25'

    labels:
      # Home Assistant monitoring
      - ha.monitor=true
      - ha.category=security
      - ha.compose-file=Docker-NonCritical/Security/security.yaml
      - ha.service-name=wazuh.dashboard
      # Traefik routing (SSL termination here)
      - traefik.enable=true
      - traefik.http.routers.wazuh.entrypoints=websecure
      - traefik.http.routers.wazuh.rule=Host(`wazuh.${DOMAIN_NAME}`)
      - traefik.http.routers.wazuh.service=wazuh
      - traefik.http.services.wazuh.loadbalancer.server.port=5601
      - traefik.http.routers.wazuh.tls.certresolver=${CERTRESOLVER}
      # Watchtower updates
      - com.centurylinklabs.watchtower.enable=true

    environment:
      - OPENSEARCH_HOSTS=http://wazuh.indexer:9200
      - WAZUH_API_URL=http://wazuh.manager:55000
      - API_USERNAME=${WAZUH_API_USERNAME:-wazuh-wui}
      - API_PASSWORD=${WAZUH_API_PASSWORD}
      # Disable SSL for internal communication
      - SERVER_SSL_ENABLED=false

    volumes:
      - wazuh-dashboard-config:/usr/share/wazuh-dashboard/data/wazuh/config
      - wazuh-dashboard-custom:/usr/share/wazuh-dashboard/plugins/wazuh/public/assets/custom

    networks:
      - secproxy

    depends_on:
      - wazuh.indexer
      - wazuh.manager

volumes:
  wazuh_api_configuration:
  wazuh_etc:
  wazuh_logs:
  wazuh_queue:
  wazuh_var_multigroups:
  wazuh_integrations:
  wazuh_active_response:
  wazuh_agentless:
  wazuh_wodles:
  filebeat_etc:
  filebeat_var:
  wazuh-indexer-data:
  wazuh-dashboard-config:
  wazuh-dashboard-custom:
