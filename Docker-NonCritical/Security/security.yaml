networks:
  secproxy:
    external: true

services:
  wazuh.indexer:
    image: wazuh/wazuh-indexer:${WAZUH_VERSION:-4.14.3}
    hostname: wazuh.indexer
    container_name: wazuh-indexer
    restart: unless-stopped

    # Resource limits
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2.0'
        reservations:
          memory: 1G
          cpus: '0.5'

    labels:
      # Home Assistant monitoring
      - ha.monitor=true
      - ha.category=security
      - ha.compose-file=Docker-NonCritical/Security/security.yaml
      - ha.service-name=wazuh.indexer
      # Watchtower updates
      - com.centurylinklabs.watchtower.enable=true

    environment:
      - OPENSEARCH_JAVA_OPTS=-Xms1g -Xmx1g
      - discovery.type=single-node
      - bootstrap.memory_lock=true
      # Disable SSL for internal communication (using Docker network)
      - plugins.security.disabled=true

    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536

    volumes:
      - /srv/wazuh/indexer-data:/var/lib/wazuh-indexer

    networks:
      - secproxy

  wazuh.manager:
    image: wazuh/wazuh-manager:${WAZUH_VERSION:-4.14.3}
    hostname: wazuh.manager
    container_name: wazuh-manager
    restart: unless-stopped

    # Resource limits
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2.0'
        reservations:
          memory: 512M
          cpus: '0.5'

    labels:
      # Home Assistant monitoring
      - ha.monitor=true
      - ha.category=security
      - ha.compose-file=Docker-NonCritical/Security/security.yaml
      - ha.service-name=wazuh.manager
      # Watchtower updates
      - com.centurylinklabs.watchtower.enable=true

    ports:
      - "1514:1514"     # Wazuh agent communication
      - "1515:1515"     # Wazuh agent enrollment
      - "514:514/udp"   # Syslog
      - "55000:55000"   # Wazuh API

    environment:
      - INDEXER_URL=http://wazuh.indexer:9200
      - INDEXER_USERNAME=${WAZUH_INDEXER_USERNAME:-admin}
      - INDEXER_PASSWORD=${WAZUH_INDEXER_PASSWORD}
      # Disable SSL for internal communication
      - FILEBEAT_SSL_VERIFICATION_MODE=none
      - API_USERNAME=${WAZUH_API_USERNAME:-wazuh-wui}
      - API_PASSWORD=${WAZUH_API_PASSWORD}

    volumes:
      # Config and state — local NVMe (fast IO)
      - /srv/wazuh/manager/api-configuration:/var/ossec/api/configuration
      - /srv/wazuh/manager/etc:/var/ossec/etc
      - /srv/wazuh/manager/queue:/var/ossec/queue
      - /srv/wazuh/manager/var-multigroups:/var/ossec/var/multigroups
      - /srv/wazuh/manager/integrations:/var/ossec/integrations
      - /srv/wazuh/manager/active-response:/var/ossec/active-response/bin
      - /srv/wazuh/manager/agentless:/var/ossec/agentless
      - /srv/wazuh/manager/wodles:/var/ossec/wodles
      - /srv/wazuh/filebeat/etc:/etc/filebeat
      - /srv/wazuh/filebeat/var:/var/lib/filebeat
      # Active logs — local NVMe (written continuously)
      - /srv/wazuh/manager/logs:/var/ossec/logs
      # Archived logs — NFS (long-term retention, sequential reads only)
      - /mnt/data/wazuh/archives:/var/ossec/logs/archives

    networks:
      - secproxy

    depends_on:
      - wazuh.indexer

  wazuh.dashboard:
    image: wazuh/wazuh-dashboard:${WAZUH_VERSION:-4.14.3}
    hostname: wazuh.dashboard
    container_name: wazuh-dashboard
    restart: unless-stopped

    # Resource limits
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.25'

    labels:
      # Home Assistant monitoring
      - ha.monitor=true
      - ha.category=security
      - ha.compose-file=Docker-NonCritical/Security/security.yaml
      - ha.service-name=wazuh.dashboard
      # Traefik routing (SSL termination here)
      - traefik.enable=true
      - traefik.http.routers.wazuh.entrypoints=websecure
      - traefik.http.routers.wazuh.rule=Host(`wazuh.${DOMAIN_NAME}`)
      - traefik.http.routers.wazuh.service=wazuh
      - traefik.http.services.wazuh.loadbalancer.server.port=5601
      - traefik.http.routers.wazuh.tls.certresolver=${CERTRESOLVER:-cloudflare}
      - traefik.http.routers.wazuh.tls.domains[0].main=wazuh.${DOMAIN_NAME}
      # Watchtower updates
      - com.centurylinklabs.watchtower.enable=true

    environment:
      - OPENSEARCH_HOSTS=http://wazuh.indexer:9200
      - WAZUH_API_URL=http://wazuh.manager:55000
      - API_USERNAME=${WAZUH_API_USERNAME:-wazuh-wui}
      - API_PASSWORD=${WAZUH_API_PASSWORD}
      # Disable SSL for internal communication
      - SERVER_SSL_ENABLED=false

    volumes:
      - ./dashboard-config/opensearch_dashboards.yml:/usr/share/wazuh-dashboard/config/opensearch_dashboards.yml:ro
      - /srv/wazuh/dashboard/config:/usr/share/wazuh-dashboard/data/wazuh/config
      - /srv/wazuh/dashboard/custom:/usr/share/wazuh-dashboard/plugins/wazuh/public/assets/custom

    networks:
      - secproxy

    depends_on:
      - wazuh.indexer
      - wazuh.manager

  # One-shot init container: applies 30-day index retention policy to the indexer
  wazuh.ism-init:
    image: curlimages/curl:latest
    container_name: wazuh-ism-init
    restart: "no"
    networks:
      - secproxy
    volumes:
      - ./indexer-config/ism-policy.json:/ism-policy.json:ro
      - ./indexer-config/apply-ism-policy.sh:/apply-ism-policy.sh:ro
    entrypoint: ["sh", "/apply-ism-policy.sh"]
    depends_on:
      - wazuh.indexer
    labels:
      - ha.monitor=true
      - ha.category=security
      - ha.compose-file=Docker-NonCritical/Security/security.yaml
      - ha.service-name=wazuh.ism-init

